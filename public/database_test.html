<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Tester - Chamindu Site</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #050505;
            color: #fff;
            padding: 40px;
        }

        .card {
            background: #111;
            border: 1px solid #222;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        h1 {
            color: #00ffa3;
        }

        button {
            background: #00ffa3;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        pre {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            color: #00ffa3;
        }

        .status {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <h1>Database Operation Tester</h1>
    <p>Use this to verify your Google Apps Script is working correctly.</p>

    <div class="card">
        <h3>1. Configuration</h3>
        <input type="text" id="scriptUrl"
            style="width: 100%; padding: 10px; background: #222; border: 1px solid #333; color: #fff; border-radius: 6px;"
            value="https://script.google.com/macros/s/AKfycbxJl9GnLuVO1Ny-JsIQusfz7cds9PvXq0tq43Ydqg2Z8NfZ9I7bWhOATziDvhbsRRc4/exec">
    </div>

    <div class="card">
        <h3>2. Actions</h3>
        <button onclick="testFullCycle()">Test Full Cycle (Add -> Get -> Delete)</button>
        <button onclick="fetchData('getProjects')">Fetch Projects</button>
        <button onclick="fetchData('getTestimonials')">Fetch Testimonials</button>
    </div>

    <div class="card">
        <h3>Log Console</h3>
        <pre id="log">Waiting for actions...</pre>
    </div>

    <script>
        const log = (msg) => {
            const el = document.getElementById('log');
            if (typeof msg === 'object') msg = JSON.stringify(msg, null, 2);
            el.innerHTML += '\n[' + new Date().toLocaleTimeString() + '] ' + msg;
        };

        async function fetchData(type) {
            const url = document.getElementById('scriptUrl').value;
            log(`Fetching ${type}...`);
            try {
                const res = await fetch(`${url}?type=${type}`);
                const data = await res.json();
                log(data);
            } catch (err) {
                log("Error: " + err.message);
            }
        }

        async function testFullCycle() {
            const url = document.getElementById('scriptUrl').value;
            log("--- STARTING TEST CYCLE ---");

            // 1. ADD
            log("1. Adding Test Project...");
            try {
                const params = new URLSearchParams({
                    type: 'addProject',
                    title: 'Test Auto Project',
                    category: 'web',
                    tech: 'Testing, JS, API',
                    image: 'https://via.placeholder.com/150',
                    url: 'https://google.com'
                });

                await fetch(url, { method: 'POST', mode: 'no-cors', body: params });
                log("POST sent (no-cors mode - check sheet in 5 seconds)");

                // Wait for sheet to process
                log("Waiting 3 seconds for propagation...");
                await new Promise(r => setTimeout(r, 3000));

                // 2. GET
                log("2. Verifying Add (Fetching Projects)...");
                const res = await fetch(`${url}?type=getProjects`);
                const projects = await res.json();
                const testProj = projects.find(p => p.title === 'Test Auto Project');

                if (testProj) {
                    log("SUCCESS: Test project found with ID: " + testProj.id);

                    // 3. DELETE
                    log("3. Deleting Test Project...");
                    const delParams = new URLSearchParams({ type: 'deleteProject', id: testProj.id });
                    await fetch(`${url}?${delParams.toString()}`, { mode: 'no-cors' });
                    log("Delete command sent (no-cors).");
                } else {
                    log("FAILED: Test project not found. Is the script deployed correctly?");
                }

            } catch (err) {
                log("Cycle Error: " + err.message);
            }
            log("--- TEST CYCLE ENDED ---");
        }
    </script>
</body>

</html>